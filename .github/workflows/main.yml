name: Compile and Run AVL (Coursework Spec)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Explore directory structure
        run: |
          echo "=== 当前目录结构 ==="
          ls -la
          echo ""
          echo "=== 查找 AVL.java 文件 ==="
          find . -name "AVL.java" -type f
          echo ""
          echo "=== 查找所有 .java 文件 ==="
          find . -name "*.java" -type f

      - name: Prepare input
        run: |
          echo "9,6,2,1,4,25,16,13,37,27,17,34,10" > Input.txt
          echo "Input.txt created"
          cat Input.txt

      - name: Measure compile time
        id: compile
        shell: bash
        run: |
          # 根据实际路径调整这里的 cd 命令
          # 如果 AVL.java 在根目录，直接编译
          # 如果在子目录，cd 到那个目录
          start_time=$(date +%s%3N)
          javac -encoding UTF-8 -sourcepath . AVL.java
          end_time=$(date +%s%3N)
          compile_time=$((end_time - start_time))
          echo "compile_time_ms=$compile_time" >> $GITHUB_OUTPUT
          echo "Compile time: $compile_time ms"

      - name: Measure run time (with required parameters)
        id: run
        shell: bash
        run: |
          start_time=$(date +%s%3N)
          java -Dfile.encoding=UTF-8 -XX:+UseSerialGC -Xss64m -Xms1920m -Xmx1920m AVL < Input.txt > Output.txt
          end_time=$(date +%s%3N)
          run_time=$((end_time - start_time))
          echo "run_time_ms=$run_time" >> $GITHUB_OUTPUT
          echo "Run time: $run_time ms"

      - name: Display results
        run: |
          echo "===== Output.txt ====="
          cat Output.txt
          echo ""
          echo "Compile time: ${{ steps.compile.outputs.compile_time_ms }} ms"
          echo "Run time: ${{ steps.run.outputs.run_time_ms }} ms"
